{% extends "CVPlatformBundle::layout.html.twig" %}

{% block title %}
    Lecture d'une annonce - {{ parent() }}
{% endblock %}

{% block cvplatform_body %}
    {% stylesheets 
        '@CVPlatformBundle/Resources/public/css/accordeon.css'
        '@CVPlatformBundle/Resources/public/css/button.css' %}
        <link rel="stylesheet" href="http://lipis.github.io/bootstrap-sweetalert/lib/sweet-alert.css">
        <link rel="stylesheet" href="{{ asset_url }}" type="text/css" />
    {% endstylesheets %}

    <div class="well">
        <p>{% include 'CVPlatformBundle:Ride:focus_details.html.twig' with {'ride': ride} %}</p></br>
        <p>
            <a href="{{ path('cv_platform_home') }}" class="btn btn-primary btn-outline btn-lg"><i class="glyphicon glyphicon-chevron-left"></i>Retour à la liste</a>
            {% if isFull %}
                <button class="btn btn-lg btn-success"><i class="glyphicon glyphicon-ok-circle"></i> Complet</button>                
            {% else %}     
                <button class="btn btn-lg btn-warning sweet-13" onclick="_gaq.push(['_trackEvent', 'example, 'try', 'Warning']);"><i class="glyphicon glyphicon-hand-up"></i> Réserver</button>
            {% endif %}
        </p>
    </div>

    <div class="well">
        <ol id="messages" class="messages">
            {% for publicMessage in listPublicMessagesOfRide %}
                {% include 'CVPlatformBundle:PublicMessage:view.html.twig' with {'publicMessage': publicMessage} %}
            {% endfor %}
        </ol>

        <p class="boutons">
            <a href="#" class="voir_tous">Tous les messages ({{ listPublicMessagesOfRide|length }})</a> 
            <a href="#" class="voir_recent">5 seulement</a>
            <a href="#" class="replier_tous">Tout replier</a>
        </p>
        <div class="well">
            <textarea id="contentT" rows="5" cols="111" placeholder="Posez vos questions ou réponses ici."></textarea><br/>
            <div align="right"><button id="publish" class="btn btn-primary" type="button" >Publier</button></div>
        </div>
    </div>
    {% javascripts 'js/jquery.js' %}
        <script src="http://lipis.github.io/bootstrap-sweetalert/lib/sweet-alert.js"></script>
        <script type="text/javascript" src="{{ asset_url }}"></script>

        <script type="text/javascript"> // Commentaires
            $(document).ready(function(){
                $(".messages .corps:gt(0)").hide();
                $(".messages li:gt(4)").hide();
                $(".entete").click(function(){
                    $(this).next(".corps").slideToggle(500)
                    return false;
                });
                $(".replier_tous").click(function(){
                    $(".corps").slideUp(500)
                    return false;
                });
                $(".voir_tous").click(function(){
                    $(this).hide()
                    $(".voir_recent").show()
                    $(".messages li:gt(4)").slideDown()
                    return false;
                });
                $(".voir_recent").click(function(){
                    $(this).hide()
                    $(".voir_tous").show()
                    $(".messages li:gt(4)").slideUp()
                    return false;
                });
            });

            $("#publish").on("click", addPublicMessage);
            function addPublicMessage(){
                var content = 'content='+document.getElementById('contentT').value;
                $.ajax({
                    url: "{{ path('cv_platform_add_public_message', {'ride': ride.id}) }}",
                    data: content,
                    success: addingPublicMessage
                }); 
            }
            function addingPublicMessage(data) {
                $("#messages").append(data);
                document.getElementById('contentT').value="";
            }
        </script>
        <script> // Boite de confirmation
            document.querySelector('.sweet-13').onclick = function(){
                swal({
                    title: "Êtes vous sure de vouloir réserver cette annonce ?",
                    text: "Vous serez débité 2 jours après le voyage",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonClass: "btn-warning",
                    confirmButtonText: "Oui",
                    cancelButtonText: "Non",
                    closeOnConfirm: false,
                    closeOnCancel: false
                },
                function(isConfirm) {
                    if (isConfirm) {
                        swal({
                            title: "Votre réservation a bien été enregistrée",
                            text: "Veuillez donner le code que nous vous avons envoyé au conducteur à la fin de votre voyage",
                            type: "success",
                            confirmButtonClass: "btn-success",
                            confirmButtonText: "Ok",
                            closeOnConfirm: true,
                        },
                        function() {
                            $.ajax({
                                url: "{{ path('cv_platform_confirm_reservation_ride', {'id': ride.id }) }}",
                                success: function(data) {
                                    window.location.replace("{{ path('cv_platform_my_reservations') }}");
                                }
                            }); 
                        });
                    } else {
                        swal({
                            title: "Annulation",
                            text: "Vous ne serez pas débité",
                            type: "error",
                            confirmButtonClass: "btn-danger",
                            confirmButtonText: "Ok",
                            closeOnConfirm: true,
                        });
                    }
                });
            };
        </script>
    {% endjavascripts %}
{% endblock %}
